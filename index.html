<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZERO KARMA : MANDALA RITUAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Noto+Sans+KR:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #00ff9d; --neon-blue: #00ccff; --neon-yellow: #ffcc00;
            --neon-red: #ff0055; --neon-white: #ffffff;
            --dark-bg: #050505; --glass: rgba(20, 20, 20, 0.85);
        }

        body {
            margin: 0; background-color: var(--dark-bg); color: #fff;
            font-family: 'Noto Sans KR', sans-serif; overflow-x: hidden;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh; padding: 20px; box-sizing: border-box;
        }

        .bubbles {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 50% 50%, rgba(0, 255, 157, 0.1) 0%, transparent 60%);
            pointer-events: none;
        }

        h1 {
            font-family: 'Orbitron', sans-serif; font-size: 1.8rem; color: var(--neon-green);
            text-shadow: 0 0 10px var(--neon-green); letter-spacing: 3px; text-align: center; margin-top: 10px;
        }

        .subtitle { font-size: 0.8rem; color: #888; margin-bottom: 30px; text-transform: uppercase; font-family: 'Orbitron', sans-serif; }

        /* ì—…ë¡œë“œ ì„¹ì…˜ */
        .upload-container {
            position: relative; width: 60vw; height: 60vw; max-width: 200px; max-height: 200px;
            display: flex; justify-content: center; align-items: center; margin-bottom: 40px;
        }
        .mantra-ring { position: absolute; width: 100%; height: 100%; animation: spin 20s linear infinite; }
        .seed-syllable {
            width: 60%; height: 60%; border-radius: 50%; background: rgba(255,255,255,0.05);
            backdrop-filter: blur(5px); border: 2px solid var(--neon-green);
            box-shadow: 0 0 20px rgba(0, 255, 157, 0.2); display: flex; justify-content: center;
            align-items: center; cursor: pointer; z-index: 10; transition: transform 0.2s;
        }
        .seed-syllable:active { transform: scale(0.95); }
        .seed-syllable span { font-size: 2.5rem; color: #fff; }
        #upload-input { display: none; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .scanning { animation: pulse 1s infinite; }
        @keyframes pulse { 50% { box-shadow: 0 0 40px var(--neon-green); } }

        /* 1. ìƒë‹¨ ë§Œë‹¤ë¼ ê·¸ë¦¬ë“œ ë°°ì¹˜ */
        #mandala-grid {
            display: grid; gap: 10px; margin-bottom: 30px;
            grid-template-areas: 
                ". north ."
                "west center east"
                ". south .";
            width: 100%; max-width: 500px;
        }
        .card {
            background: var(--glass); border: 1px solid #333; padding: 10px;
            border-top: 3px solid; display: flex; flex-direction: column;
            align-items: center; text-align: center; position: relative; min-height: 80px;
        }
        .card-pos { grid-area: auto; } /* JSë¡œ í• ë‹¹ */
        .direction-label { font-size: 0.6rem; color: #777; letter-spacing: 1px; margin-bottom: 5px; font-family: 'Orbitron', sans-serif; }
        .card-title-kr { font-size: 0.9rem; font-weight: 700; margin-bottom: 2px; }
        .card-title-en { font-size: 0.7rem; color: #aaa; margin-bottom: 5px; font-family: 'Orbitron', sans-serif;}
        .card-value { font-size: 1.1rem; font-weight: bold; margin-top: auto; }
        
        /* 2. ì¤‘ì•™ ì§„ë‹¨ ë°•ìŠ¤ */
        #diagnosis-section {
            width: 100%; max-width: 500px; display: none; /* ë¶„ì„ ì „ ìˆ¨ê¹€ */
            animation: slideUp 0.8s ease-out; margin-bottom: 30px;
        }
        .diagnosis-card {
            background: rgba(0,0,0,0.9); border: 2px solid var(--neon-green); padding: 20px;
            text-align: center; box-shadow: 0 0 20px rgba(0, 255, 157, 0.15);
        }
        .diag-header { font-size: 1rem; color: #fff; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; font-family: 'Orbitron', sans-serif;}
        .diag-result { font-size: 1.3rem; font-weight: bold; color: var(--neon-green); word-break: keep-all; }

        /* 3. í•˜ë‹¨ ìˆ˜í–‰ ì²˜ë°© ì„¹ì…˜ */
        #remedy-section {
            width: 100%; max-width: 500px; display: none; /* ë¶„ì„ ì „ ìˆ¨ê¹€ */
            animation: slideUp 1s ease-out; padding-bottom: 50px;
        }
        .remedy-box {
            background: var(--glass); border-left: 4px solid #555; padding: 15px; margin-bottom: 15px;
        }
        .remedy-label { font-size: 0.8rem; color: #888; margin-bottom: 8px; display: block; font-family: 'Orbitron', sans-serif; letter-spacing: 1px;}
        .sutra-text { font-size: 0.95rem; font-style: italic; color: #ddd; line-height: 1.5; word-break: keep-all;}
        .practice-text { font-size: 0.95rem; color: #fff; line-height: 1.6; word-break: keep-all; white-space: pre-line;}
        .mantra-text { font-family: 'Orbitron', monospace; color: var(--neon-green); font-size: 1rem; text-align: center; letter-spacing: 1px; border: 1px dashed var(--neon-green); padding: 10px; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="bubbles"></div>
    <h1>ZERO KARMA</h1>
    <div class="subtitle">Mandala Ritual System</div>

    <div class="upload-container">
        <svg class="mantra-ring" viewBox="0 0 300 300">
            <path id="circlePath" d="M 150, 150 m -120, 0 a 120,120 0 0,1 240,0 a 120,120 0 0,1 -240,0" fill="none"/>
            <text fill="#00ff9d" font-size="13" font-family="monospace" letter-spacing="3">
                <textPath href="#circlePath">OM TARE TUTTARE TURE SOHA à¥ OM TARE TUTTARE TURE SOHA à¥</textPath>
            </text>
        </svg>
        <label for="upload-input" class="seed-syllable" id="drop-zone"><span>ğ‘–ğ‘–¾</span></label>
        <input type="file" id="upload-input" accept="image/*">
    </div>

    <div id="mandala-grid"></div>

    <div id="diagnosis-section">
        <div class="diagnosis-card" id="diag-card">
            <div class="diag-header">Current State Diagnosis</div>
            <div class="diag-result" id="diag-result"></div>
        </div>
    </div>

    <div id="remedy-section">
        <div class="remedy-box" id="sutra-box">
            <span class="remedy-label">â… . SUTRA WISDOM (ê²½ì „ì˜ ì§€í˜œ)</span>
            <div class="sutra-text" id="sutra-text"></div>
        </div>
        <div class="remedy-box" id="practice-box">
            <span class="remedy-label">â…¡. TANTRA PRACTICE (íƒ„íŠ¸ë¼ ìˆ˜í–‰)</span>
            <div class="practice-text" id="practice-text"></div>
        </div>
        <div class="remedy-box" id="mantra-box">
            <span class="remedy-label" style="text-align: center;">â…¢. MANTRA CODE (ì§„ì–¸)</span>
            <div class="mantra-text" id="mantra-text"></div>
        </div>
    </div>

    <canvas id="canvas" style="display:none;"></canvas>

<script>
    const uploadInput = document.getElementById('upload-input');
    const dropZone = document.getElementById('drop-zone');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Sections
    const mandalaGrid = document.getElementById('mandala-grid');
    const diagnosisSection = document.getElementById('diagnosis-section');
    const remedySection = document.getElementById('remedy-section');

    // Data Structure (Expanded for Requirements)
    const TARGETS = {
        'White': { 
            hue: 0, color: 'var(--neon-white)',
            gridArea: 'center',
            direction_kr: 'ì¤‘ì•™ (Center)',
            sanskrit_kr: 'ë¹„ë¡œìë‚˜ë¶ˆ (Vairocana)',
            wisdom_kr: 'ë²•ê³„ì²´ì„±ì§€ (Dharma-Realm Wisdom)',
            // Diagnosis & Remedy
            diagnosis: "ê·¼ì›ì  í˜¼ë€ / ë¬´ì§€ í˜¹ì€ ìˆœìˆ˜",
            sutra: "ã€Œë§ˆìŒë„ ì—†ê³ , ë§ˆìŒ ì•„ë‹˜ë„ ì—†ê³ , ë§ˆìŒ ì—†ìŒë„ ì—†ë‚˜ë‹ˆ, ì‚¼ì„¸ì˜ ì¼ì²´ ëª¨ë“  ë¶€ì²˜ë‹˜ì´ ì´ ê°€ìš´ë°ì„œ ë°©í¸ìœ¼ë¡œ ë‚˜ì‹œëŠë‹ˆë¼.ã€ - ëŒ€ìŠ¹ê¸°ì‹ ë¡ ",
            practice: "[ë¦¬ì…‹ ëª…ìƒ] ì§€ê¸ˆ ì´ ìˆœê°„, ëª¨ë“  ìƒê°ê³¼ íŒë‹¨ì„ ë©ˆì¶”ì‹­ì‹œì˜¤. í…… ë¹ˆ ìº”ë²„ìŠ¤ì²˜ëŸ¼ 'ëª¨ë¦„'ì˜ ìƒíƒœë¡œ ëŒì•„ê°€ ê¹Šì€ ì‹¬í˜¸í¡ì„ 3ë²ˆ í•˜ì‹­ì‹œì˜¤.",
            mantra: "OM VAIROCANA HUM (ì˜´ ë² ë¡œìë‚˜ í›”)"
        },
        'Blue': { 
            hue: 240, color: 'var(--neon-blue)',
            gridArea: 'east',
            direction_kr: 'ë™ë°© (East)',
            sanskrit_kr: 'ì•„ì´‰ë¶ˆ (Akshobhya)',
            wisdom_kr: 'ëŒ€ì›ê²½ì§€ (Mirror-like Wisdom)',
            // Diagnosis & Remedy
            diagnosis: "ì°¨ê°€ìš´ ë¶„ë…¸ / ì´ì„±ì˜ ê³¼ì—´",
            sutra: "ã€Œì„±ë‚´ëŠ” ë§ˆìŒì€ ë¶ˆê¸¸ ê°™ì•„ì„œ ì˜¨ê°– ê³µë•ì˜ ìˆ²ì„ íƒœì›Œë²„ë¦°ë‹¤.ã€ - ëŒ€ì§€ë„ë¡ ",
            practice: "[ê±°ìš¸ ê´€ìƒ] ë‹¹ì‹ ì˜ ê°ì •ì€ ë‹¹ì‹ ì´ ì•„ë‹™ë‹ˆë‹¤. ê±°ìš¸ì— ë¹„ì¹œ ì˜ìƒì¼ ë¿ì…ë‹ˆë‹¤. ì°¨ê°€ìš´ ë¬¼ì´ë‚˜ íƒ„ì‚°ìˆ˜ë¥¼ ë§ˆì‹œë©° ëœ¨ê±°ìš´ ì†ì„ ì‹íˆëŠ” ê´€ìƒì„ í•˜ì‹­ì‹œì˜¤.",
            mantra: "OM VAJRA ARGA SOHA (ì˜´ ë°”ì¦ˆë¼ ì•„ë¥´ê°€ ì†Œí•˜)"
        },
        'Yellow': { 
            hue: 60, color: 'var(--neon-yellow)',
            gridArea: 'south',
            direction_kr: 'ë‚¨ë°© (South)',
            sanskrit_kr: 'ë³´ìƒë¶ˆ (Ratnasambhava)',
            wisdom_kr: 'í‰ë“±ì„±ì§€ (Equality Wisdom)',
            // Diagnosis & Remedy
            diagnosis: "ìì¡´ê° ê²°í• / í˜¹ì€ ì˜¤ë§Œ",
            sutra: "ã€Œë‚˜ë‹¤, ë‚¨ì´ë‹¤ í•˜ëŠ” ë¶„ë³„ì„ ë‚´ì§€ ë§ˆë¼. ëª¨ë“  ì¡´ì¬ëŠ” ë³¸ë˜ í‰ë“±í•˜ë‹¤.ã€ - ìœ ë§ˆê²½",
            practice: "[ëŒ€ì§€ ì ‘ì´‰] ì²™ì¶”ë¥¼ ê³§ê²Œ í´ê³  ì•‰ì•„ ì—‰ë©ì´ê°€ ë°”ë‹¥ì— ë‹¿ëŠ” ëŠë‚Œì— ì§‘ì¤‘í•˜ì‹­ì‹œì˜¤. ë‹¹ì‹ ì€ ì´ë¯¸ ì´ ëŒ€ì§€ì²˜ëŸ¼ ê²¬ê³ í•˜ê³  í’ìš”ë¡­ìŠµë‹ˆë‹¤.",
            mantra: "OM RATNA SURYA SOHA (ì˜´ ë¼íŠ¸ë‚˜ ìˆ˜ë¦¬ì•¼ ì†Œí•˜)"
        },
        'Red': { 
            hue: 0, color: 'var(--neon-red)',
            gridArea: 'west',
            direction_kr: 'ì„œë°© (West)',
            sanskrit_kr: 'ì•„ë¯¸íƒ€ë¶ˆ (Amitabha)',
            wisdom_kr: 'ë¬˜ê´€ì°°ì§€ (Discriminating Wisdom)',
            // Diagnosis & Remedy
            diagnosis: "ê°•ë ¬í•œ ìš•ë§ / ê´€ê³„ì˜ ê°ˆì¦",
            sutra: "ã€Œìš•ë§ì€ ì†Œê¸ˆë¬¼ê³¼ ê°™ì•„ì„œ ë§ˆì‹¤ìˆ˜ë¡ ëª©ì´ ë§ˆë¥´ë‹¤. ì˜¤ì§ ìë¹„ì‹¬ë§Œì´ ì´ ê°ˆì¦ì„ ì¬ìš´ë‹¤.ã€ - ë²•êµ¬ê²½",
            practice: "[ìë¹„ ë³€í™˜] íƒ€ì¸ì„ í–¥í•œ ëœ¨ê±°ìš´ ìš•ë§ì„, ê·¸ë“¤ì´ í–‰ë³µí•˜ê¸°ë¥¼ ë°”ë¼ëŠ” ë”°ëœ»í•œ ìë¹„ì‹¬ìœ¼ë¡œ ìƒìƒí•˜ë©° ì‹¬ì¥ìœ¼ë¡œ í˜¸í¡í•˜ì‹­ì‹œì˜¤.",
            mantra: "OM ARO LIK SOHA (ì˜´ ì•„ë¡œ ë¦­ ì†Œí•˜)"
        },
        'Green': { 
            hue: 120, color: 'var(--neon-green)',
            gridArea: 'north',
            direction_kr: 'ë¶ë°© (North)',
            sanskrit_kr: 'ë¶ˆê³µì„±ì·¨ë¶ˆ (Amoghasiddhi)',
            wisdom_kr: 'ì„±ì†Œì‘ì§€ (All-Accomplishing Wisdom)',
            // Diagnosis & Remedy
            diagnosis: "ì‹¤í–‰ ë¶ˆì•ˆ / ì§ˆíˆ¬ì™€ ì¡°ê¸‰í•¨",
            sutra: "ã€Œë‘ë ¤ì›Œ ë§ˆë¼. í–‰í•˜ëŠ” ìì—ê²Œ ê¸¸ì€ ì—´ë¦°ë‹¤. ëª¨ë“  ê²ƒì€ ë§ˆìŒì´ ì§€ì–´ë‚´ëŠ” ê²ƒì´ë‹¤.ã€ - í™”ì—„ê²½",
            practice: "[ì¦‰ê° í–‰ë™] ìƒê°ì´ ë§ìœ¼ë©´ ë°œì´ ë¬¶ì…ë‹ˆë‹¤. ê°€ì¥ ì‘ì€ ì¼ í•˜ë‚˜ë¥¼ ì§€ê¸ˆ ë‹¹ì¥ ì‹¤í–‰í•˜ì‹­ì‹œì˜¤. (ì˜ˆ: ì±…ìƒ ì •ë¦¬, ìŠ¤ì¿¼íŠ¸ 10íšŒ)",
            mantra: "OM TARE TUTTARE TURE SOHA (ì˜´ íƒ€ë ˆ íˆ¬íƒ€ë ˆ íˆ¬ë ˆ ì†Œí•˜)"
        }
    };

    // Mandala Grid Order (for looping)
    const MANDALA_KEYS = ['Green', 'Red', 'White', 'Blue', 'Yellow']; // N, W, C, E, S order for layout

    uploadInput.addEventListener('change', handleFile);

    function handleFile(e) {
        const file = e.target.files[0];
        if (!file) return;
        resetUI();
        dropZone.classList.add('scanning'); dropZone.innerHTML = "<span>à¥</span>";

        const img = new Image();
        img.onload = () => {
            const MAX_SIZE = 500;
            let w = img.width, h = img.height;
            if (w > h) { if (w > MAX_SIZE) { h *= MAX_SIZE/w; w = MAX_SIZE; } } 
            else { if (h > MAX_SIZE) { w *= MAX_SIZE/h; h = MAX_SIZE; } }
            canvas.width = w; canvas.height = h; ctx.drawImage(img, 0, 0, w, h);
            setTimeout(() => { analyzeFuzzy(ctx.getImageData(0,0,w,h)); dropZone.classList.remove('scanning'); dropZone.innerHTML = "<span>ğ‘–ğ‘–¾</span>"; }, 800);
        };
        img.src = URL.createObjectURL(file);
    }

    function resetUI() {
        mandalaGrid.innerHTML = '';
        diagnosisSection.style.display = 'none';
        remedySection.style.display = 'none';
    }

    function rgbToHsv(r, g, b) { /* (ì´ì „ê³¼ ë™ì¼) */ r/=255,g/=255,b/=255;let max=Math.max(r,g,b),min=Math.min(r,g,b);let h,s,v=max;let d=max-min;s=max==0?0:d/max;if(max==min){h=0}else{switch(max){case r:h=(g-b)/d+(g<b?6:0);break;case g:h=(b-r)/d+2;break;case b:h=(r-g)/d+4;break;}h/=6}return[h*360,s,v]; }
    function getMembership(value, target, range=45) { let diff=Math.abs(value-target);if(diff>180)diff=360-diff;if(diff>range)return 0;return 1-(diff/range); }

    function analyzeFuzzy(imageData) {
        const data = imageData.data;
        let scores = { 'Blue':0,'Yellow':0,'Red':0,'Green':0,'White':0 };
        for (let i=0; i<data.length; i+=16) {
            let r=data[i],g=data[i+1],b=data[i+2]; let [h,s,v]=rgbToHsv(r,g,b);
            let whiteScore=0; if(s<0.15 && v>0.8) { whiteScore=(1-s)*v; scores['White']+=whiteScore; }
            if(whiteScore<0.8) { for(let key of ['Red','Blue','Yellow','Green']){ let mem=getMembership(h,TARGETS[key].hue); let intensity=mem*s*v; if(intensity>0)scores[key]+=intensity; }}
        }
        let totalScore = Object.values(scores).reduce((a,b)=>a+b,0);

        // 1. ìƒë‹¨ ë§Œë‹¤ë¼ ê·¸ë¦¬ë“œ ë Œë”ë§
        MANDALA_KEYS.forEach(key => {
            let percent = totalScore > 0 ? (scores[key]/totalScore*100).toFixed(1) : 0;
            let card = document.createElement('div');
            card.className = 'card'; card.style.borderColor = TARGETS[key].color; card.style.gridArea = TARGETS[key].gridArea;
            card.innerHTML = `
                <div class="direction-label">${TARGETS[key].direction_kr}</div>
                <div class="card-title-kr">${TARGETS[key].sanskrit_kr}</div>
                <div class="card-title-en">${TARGETS[key].wisdom_kr.split('(')[1].replace(')','')}</div>
                <div class="card-value" style="color:${TARGETS[key].color}">${percent}%</div>
            `;
            mandalaGrid.appendChild(card);
        });

        // 2. & 3. ì§„ë‹¨ ë° ì²˜ë°© ë Œë”ë§ (ê°€ì¥ ë†’ì€ ì ìˆ˜ ê¸°ì¤€)
        if (totalScore > 0) {
            let maxKey = Object.keys(scores).reduce((a, b) => scores[a] > scores[b] ? a : b);
            let data = TARGETS[maxKey];

            // ì§„ë‹¨ ë°•ìŠ¤
            document.getElementById('diag-card').style.borderColor = data.color;
            document.getElementById('diag-result').innerText = data.diagnosis;
            document.getElementById('diag-result').style.color = data.color;
            diagnosisSection.style.display = 'block';

            // ì²˜ë°© ì„¹ì…˜ (ë¶ˆê²½ -> ìˆ˜í–‰ -> ë§ŒíŠ¸ë¼)
            document.getElementById('sutra-box').style.borderColor = data.color;
            document.getElementById('sutra-text').innerText = data.sutra;
            
            document.getElementById('practice-box').style.borderColor = data.color;
            document.getElementById('practice-text').innerText = data.practice;

            document.getElementById('mantra-box').style.borderColor = data.color;
            document.getElementById('mantra-text').innerText = data.mantra;
            document.getElementById('mantra-text').style.color = data.color;
            document.getElementById('mantra-text').style.borderColor = data.color;

            remedySection.style.display = 'block';
        }
    }
</script>
</body>
</html>
